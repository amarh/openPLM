{% extends "base.html" %}
{% load i18n plmapp_tags %}

<!-- Manage html display in the Content div which correspond to the "files" menu -->

{% block css %}
<link type="text/css" href="/media/css/files.css" rel="Stylesheet" />
<style type="text/css">
.hidden{
    display:none;
}
</style> 
{% endblock %}
{% block scripts %}

    <script type="text/javascript">
        $(document).ready(function () {
            $("#dialog_check-out").dialog({
            modal: true,
            autoOpen: false
            });
            $("a.check-out").click(function(e) {
                e.preventDefault();
                var url = $(this).attr("href");
                $("#dialog_check-out").dialog('option', 'buttons', {
                    "CANCEL": function() {
                        $(this).dialog("close");
                        },
                        "CHECK-OUT": function() {
                        $(location).attr('href',url); 
                        $(this).dialog("close");
                        }
                    });
                    $("#dialog_check-out").dialog();
                    $("#dialog_check-out").dialog("open");
                    return false;
            });

            $("#s_all").click(function(){
                $("td.Content > input:checkbox").attr("checked",true);
                $("#s_all").addClass("hidden");
                $("#des_all").removeClass("hidden");
            });
            $("#des_all").click(function(){
                $("td.Content > input:checkbox").attr("checked",false);
                $("#s_all").removeClass("hidden");
                $("#des_all").addClass("hidden");
            });

        });
    </script>

{% endblock scripts %}

{% block content %}
{% if is_owner and obj.is_editable %}
<div id="add_file_container" style="border-bottom: 2px dotted black; padding-bottom:1%; margin-bottom:1%" class="hidden">
    <a id="add-file-nojs" href="add/">{% trans "Add file (no javascript)" %}</a>
{% include "documents/files_add.html" %}
</div>
{% else %}
    {% if is_owner %}
        {% trans "The status of this document does not allow adding/deleting files." %}
    {% else %}
        {% trans "You don't have the necessary rights to add/delete files."%}
    {% endif %}
{% endif %}
    {% if file_formset.total_form_count %}
        <form class="archive_form" method="GET" action="./archive/">
            {{ archive_form.as_p }}
            <input type="submit" class="tb-btn" value="{% trans "Download all files" %}"/>
        </form>
    {% endif %}
    <form method="POST" action="">
        {% if is_owner and obj.is_editable %}
            {{ file_formset.management_form }}
	    <noscript>
            <a class="{{"Button"|button:"button-text-icon-primary"}}" href="./add/">
                <span class="ui-button-icon-primary ui-icon ui-icon-document">&nbsp;</span>
                <span class="ui-button-text">{% trans "ADD" %}</span>
            </a>
	    </noscript>
            {% if file_formset.total_form_count %}
                <input type="submit" class="tb-btn" value="{% trans "DELETE" %}"/>
                <input type="button" class="tb-btn" value="{% trans "CHECK ALL" %}" id="s_all"/>
                <input type="button" class="tb-btn hidden" value="{% trans "UNCHECK ALL" %}" id="des_all"/>
            {% endif %}
        {% else %}
            {# placeholder since archive_form: float is right #}
            <span>&nbsp;</span>
        {% endif %}
        <table class="Content">
            {% for form in file_formset.forms %}
                <tr class="Content">
                    {{ form.id }}
                    {{ form.document }}
                    {% with form.instance as instance %}
                        <td class="Content" style="width:50px; text-align:center">{{ form.delete }}</td>
                        <td class="Content ui-state-default ui-state-corner-all">
                            {% if instance.locked %}
                                <span class="ui-icon ui-icon-locked">{% trans "Locked" %}</span>
                            {% else %}
                                <span class="ui-icon ui-icon-unlocked">{% trans "Unlocked" %}</span>
                            {% endif %}
                        </td>
                        <td class="Content">
                            <a href="/file/{{instance.id}}/{{instance.filename|urlencode}}">{{instance.filename}}</a></td>
                        <td class="Content">{{instance.size|filesizeformat}}</td>
                        <td class="Content">
                            <a class="tb-btn" href="/file/{{instance.id}}/{{instance.filename|urlencode}}">
                                <span class="ui-button-text">{% trans "DOWNLOAD" %}</span>
                            </a>
                        </td>
                        <td class="Content">

                            {% if is_owner and obj.is_editable %}

                                {% if instance.locked %}
                                    <a class="tb-btn" href="./checkin/{{instance.id|urlencode }}/">
                                        <span class="ui-button-text check-in">{% trans "CHECK-IN" %}</span>
                                    </a>
                                {% else %}

                                    {% if instance.checkout_valid %}

                                        <a class="tb-btn
                                            {% if instance.native_related %}check-out {% endif %}"
                                            href="./checkout/{{instance.id|urlencode }}/">
                                            <span id="{{instance.id}}" class="ui-button-text">{% trans "CHECK-OUT" %}</span>
                                        </a>                                    


                                    {% else %}
                                        {% trans "Native related file is locked" %}
                                    {% endif %}
                                {% endif %} 

                            {% else %}
                                {{ is_owner|yesno:"Object is not editable, you are not the owner" }}
                            {% endif %}

                        </td>
                        <td class="Content">
                            <a href="/file/revisions/{{instance.id}}/">{{ instance.revision }}</a>
                        </td>
                        <td class="Content">
                            {% if instance.thumbnail %}
                                <img class="thumbnail" src="{{instance.thumbnail.url}}"
                                alt="Thumbnail"/>
                            {% else %}
                                {% trans "No thumbnail available" %}
                            {% endif %}
                        </td>
                    {% endwith %}
                </tr>
            {% endfor %}	    
        </table>

    </form>
    {% if can_generate_pdf %}
        <div>
            <a href="../pdf/" class="tb-btn">
                <span class="ui-button-text">{% trans "Download merged PDF files"%}</span>
            </a>
        </div>

    {% endif %}

    <div id="dialog_check-out" title="{% trans "Confirm CHECK-OUT" %}">
        {% trans "You'are checking out a standardfile while a native file is available. Your native file will be deprecated and will not be usable anymore." %}
    </div>

    {% if deprecated_files %}

        <div id="deprecated_files">
            <h6>{% trans "Deprecated files:" %}</h6>
            {% for doc_file in deprecated_files %}        
                <p><a href="/file/revisions/{{doc_file.id}}/">{{doc_file.filename}}</a></p>            
            {% endfor %}    
        </div>
    {% endif %}
{% endblock %}


